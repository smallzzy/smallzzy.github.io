---
layout: post
title:
date: 2021-09-23 17:46
category:
author:
tags: []
summary:
---

https://wiki.osdev.org/PCI
http://xillybus.com/tutorials/pci-express-tlp-pcie-primer-tutorial-guide-1/
http://xillybus.com/tutorials/pci-express-tlp-pcie-primer-tutorial-guide-2

## layer

1. Transaction Layer Packet
2. Data Link: make sure that packet is delivered
3. Physical Layer

## pci configuration space

- 0-64 byte config space header
  - two header types are defined
    - type 0 for device
    - type 1 for switch
  - contains BAR info
- 64-256 byte standard config space
- above 256 byte extended config space
  - PCIe extends config space to 4 KB

## BAR

- base address register (BAR) will specify
  - memory type
  - memory size
- defined in pci config space
  - bit 0 = 0 for MEM, 1 for IO
  - for MEM
    - bit 1-2 set address range -> where the assigned address should locate at
      - 0x0: 32-bit, 0x10: 64-bit
    - bit 3 = prefetchable -> cacheable
- determine memory size by:
  - write 0xFF and read back
  - clear information bits
  - invert and increment by 1 -> 16 byte to 2 GB
  - memory size also specify memory alignment requirement

- traditionally address is determined during enumeration
  - Root port is responsible to enumerate all devices on the bus
- one of the extended capability is resizable BAR

### IO BAR

- IO type is for backwards support
- only support Non-posted
- only support 32-bit

## topology

```bash
dmidecode # read hardware infomation
lspci
# -t -> show as tree structure
# -v -> use more v for increased verbosity
# -s -> select certain address for printing
# LnkCap -> PCIe supported link speed
# LnkSta -> PCIe current link speed
lshw
lstopo # show system topology
```

- PCI has a bus topology. The devices share a bus have the same `segment`
- PCIe has a tree-like P2P topolgy. Each link has its own segment.
  - So, there is the notion of PCIe `segment group` for referring to all links on same tree
  - The root of the tree is connected to the CPU
    - the switch at the root is the `PCIe root complex`?
    - the port to the CPU is the `root port`?
- There can be multiple root complex. Thus, multiple segment groups
  - different segement groups are identified as domain in linux (16-bit)
  - BDF are assigned & transmitted on the bus
    - bus (8 bits), device (5 bits) and function (3 bits)
    - `setpci -s 00:02.1 F4.B`
      - `00:02.1`
      - offset `F4`
      - B, W, L = 1, 2, 4 bytes
- PCIe lane might be provided by PCH. But they still show up in one root port
  - NUMA implication?

## reset

- secondary bus reset (SBR)
- functional level reset(FLR)

## misc

- bifurcation: allow a wider port to be split between devices
  - this is a feature that need support from pcie controller
- bus mastering: allow device to post TLP
  - Command Register bit 2
  - peer device has its own DMA instead of using CPU
  - requires bus arbitration
- Posted vs Non-Posted:
  - Non-posted request need to wait for completion explictly

## signal integrity

- inter symbol interference
  - BKV?

## Message Signalled Interrupts

- pin-based interrupt (PCI)
  - pin count is limited -> cost
  - pins are shared between devices
  - out of band interrupt might race with in band data
    - requires synchronization -> performance cost
- Message Signalled Interrupts: MSI (PCI 2.2), MSI-X (PCI 3.0)
  - no interrupt pin in PCIe
  - device send data to processor as part of the interrupt
    - which determines what interrupt to trigger

### INTx and MSI/MSI-X

- INTx is a meesage type TLP?

## todo

Single Root I/O Virtualization (SR-IOV)

Physial Function: actual pcie device
Virtual Function

https://blog.scottlowe.org/2009/12/02/what-is-sr-iov/
https://dshcherb.github.io/2019/02/02/interpreting-pcie-device-to-cpu-locality-information.html

MXS824 PCIE switch

- power state / link training is controlled by hardware
  - with null packet being sent continously if power on?
  - link speed can be tuned down for low power?

MXS824 PCIE switch

## boot option

- `pci=realloc=off`
  - how the realloc is done?
  - root port mmio size?
  - sriov bar?

above 4 g decoding?

```
pci=earlydump
```

```
pci=realloc=off
```

https://paritycheck.wordpress.com/2008/01/13/pcie-posted-vs-non-posted-transactions/

https://www.semisaga.com/2019/07/pcie-tlp-header-packet-formats-address.html
